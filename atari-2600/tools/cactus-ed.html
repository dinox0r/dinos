<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸŒµ CacTus Ed ðŸŒµ</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      background: #222;
      font-family: sans-serif;
    }

    .editor-container {
      display: flex;
      width: 100%;
    }

    .grid-panel {
      flex: 3;
      overflow: auto;
      padding: 10px;
      box-sizing: border-box;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(80, 20px);
      grid-template-rows: repeat(64, 20px);
      gap: 1px;
    }

    .pixel {
      width: 20px;
      height: 20px;
    }

    .pixel.on svg rect {
      fill: #3f3f3e;
    }

    .pixel.m1 {
      cursor: pointer;
      outline: 1px solid #a77;
      background-color: #a77;
    }

    .pixel.grp1 {
      outline: 1px solid #aa7;
      background-color: #aa7;
      cursor: pointer;
    }

    .code-panel {
      flex: 1;
      background: #111;
      color: #ccc;
      display: flex;
      flex-direction: column;
    }

    .code-output {
      flex: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }

    .code-output textarea {
      flex: 1;
      width: 100%;
      resize: none;
      background: #222;
      color: #0f0;
      border: none;
      padding: 10px;
      font-family: monospace;
      font-size: 14px;
    }

    .mini-panel {
      height: 200px;
      padding: 5px;
      border-top: 1px solid #333;
      overflow: auto;
    }

    .mini-grid {
      display: grid;
      grid-template-columns: repeat(80, 4px);
      grid-template-rows: repeat(64, 4px);
      gap: 0px;
    }

    .mini-pixel {
      width: 4px;
      height: 4px;
      background: #d2d2d1;
    }

    .mini-pixel.on {
      background: #3f3f3e;
    }

    .mini-pixel.top {
      background: linear-gradient(to bottom, #3f3f3e 50%, #d2d2d1 50%);
    }

    .mini-pixel.bottom {
      background: linear-gradient(to bottom, #d2d2d1 50%, #3f3f3e 50%);
    }

    .pixel svg {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="editor-container">
    <div class="grid-panel">
      <div class="grid" id="pixelGrid"></div>
    </div>
    <div class="code-panel">
      <div class="code-output">
        <h3>Output</h3>
        <textarea readonly id="codeBox">// Sprite code will appear here</textarea>
      </div>
      <div class="mini-panel">
        <h4>Preview</h4>
        <div class="mini-grid" id="miniGrid"></div>
      </div>
    </div>
  </div>

  <script>
    const board = [
      "", "", "", "", "", "", "", "", "", "", "", "", "", //
      "            ________                                                           ", //
      "           _O^OOOOOO_                          OO                              ", //
      "           OO_OOOOOOO                         OOO                              ", //
      "           OOOOOOOOOO                        OOOOO                             ", //
      "           OOOOOOOOOO                       OOOOOOOOOOO                        ", //
      "           OOOOO^^^^^                            OOOOOOOOOOO                   ", //
      "           OOOOO___                               OOOOOOOO                     ", //
      "    _     _OOOO^^^^                               OOOOOOOOO                    ", //
      "    O    _OOOOO                                   OOOOOO                       ", //
      "    O_  _OOOOOO__                                 OOO                          ", //
      "    OO__OOOOOOO^O                                 OO                           ", //
      "    OOOOOOOOOOO ^                                 OO                           ", //
      "    ^OOOOOOOOOO                                   O                            ", //
      "     ^OOOOOOOO^                                                                ", //
      "      ^OOO^OO^                                                                 ", //
      "       O^^ ^O                                                                  ", //
      "____   O_   O       ______________________________________________________     ", //
      "       ^^   O_                                                                 ", //
      "            ^^                                                                 ", //
      "                                                                               ", //
      "", "", "", "", "", "", "", "", "", "", "", "", "" //
    ];
    const grid = document.getElementById('pixelGrid');
    const mini_grid = document.getElementById('miniGrid');
    const rows = board.length;
    const cols = 80;

    const cactus_grp1_x = 23;
    const cactus_grp1_y = 17;
    const cactus_grp1_h = 17;
    const cactus_grp1_w = 8;
    const cactus_m1_x = cactus_grp1_x + 8;
    const cactus_m1_y = cactus_grp1_y;
    const cactus_m1_h = cactus_grp1_h;
    const cactus_m1_w = 16;

    let grp1 = [...Array(cactus_grp1_h)].map(() => Array(cactus_grp1_w).fill(0));
    let m1 = [...Array(cactus_m1_h)].map(() => Array(2).fill(0));
    let is_mouse_down = false;
    let mouse_down_processed_pixels = [...Array(cactus_grp1_h)].map(() => Array(cactus_grp1_w).fill(0));

    document.body.addEventListener('mousedown', () => is_mouse_down = true);
    document.body.addEventListener('mouseup', () => {
      is_mouse_down = false;
      mouse_down_processed_pixels.forEach(row => row.fill(0));
      update_sprite_code();
      update_mini_grid(); // Keep preview in sync
    });

    function create_pixel_svg(type) {
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("viewBox", "0 0 1 1");

      const top = document.createElementNS(svgNS, "rect");
      top.setAttribute("x", 0);
      top.setAttribute("y", 0);
      top.setAttribute("width", 1);
      top.setAttribute("height", 0.5);

      const bottom = document.createElementNS(svgNS, "rect");
      bottom.setAttribute("x", 0);
      bottom.setAttribute("y", 0.5);
      bottom.setAttribute("width", 1);
      bottom.setAttribute("height", 0.5);

      if (type === 'on') {
        top.setAttribute("fill", "#3f3f3e");
        bottom.setAttribute("fill", "#3f3f3e");
      } else if (type === 'top') {
        top.setAttribute("fill", "#3f3f3e");
        bottom.setAttribute("fill", "#d2d2d1");
      } else if (type === 'bottom') {
        top.setAttribute("fill", "#d2d2d1");
        bottom.setAttribute("fill", "#3f3f3e");
      } else {
        top.setAttribute("fill", "#d2d2d1");
        bottom.setAttribute("fill", "#d2d2d1");
      }

      svg.appendChild(top);
      svg.appendChild(bottom);
      return svg;
    }

    function update_mini_grid() {
      mini_grid.innerHTML = '';
      for (let i = 0; i < rows; i++) {
        for (let j = 0; j < cols; j++) {
          const miniPixel = document.createElement('div');
          miniPixel.classList.add('mini-pixel');

          const bij = board[i] ? board[i][j] : ' ';
          if (bij === '_') miniPixel.classList.add('bottom');
          else if (bij === '^') miniPixel.classList.add('top');
          else if (bij === 'O') miniPixel.classList.add('on');

          const ii = i - cactus_grp1_y;
          const jj = j - cactus_grp1_x;
          if (0 <= ii && ii < cactus_grp1_h && 0 <= jj && jj < cactus_grp1_w) {
            if (grp1[ii][jj]) miniPixel.classList.add('on');
          }

          const mii = i - cactus_m1_y;
          const mjj = j - cactus_m1_x;
          if (0 <= mii && mii < cactus_m1_h && m1[mii][0]) {
            const size = 1 << (m1[mii][0] - 1);
            const offset = m1[mii][1];
            if (mjj >= offset && mjj < offset + size) {
              miniPixel.classList.add('on');
            }
          }

          mini_grid.appendChild(miniPixel);
        }
      }
    }

    function toggle_pixel(pixel) {
      const ii = pixel.i;
      const jj = pixel.j;
      if (ii === 0 || ii === 16) return;
      grp1[ii][jj] = !grp1[ii][jj] & 1;
      pixel.classList.toggle('on');
    }

    function toggle_missile_pixel(pixel) {
      const ii = pixel.i;
      const jj = pixel.j;
      if (ii === 0 || ii === 16) return;
      const i = ii + cactus_m1_y;
      const j = jj + cactus_m1_x;

      for (let x = 0; x < cactus_m1_w; x++) {
        const p = document.getElementById('p' + i + '_' + (cactus_m1_x + x));
        p.classList.remove('on');
      }

      if (m1[ii][0] === 4) {
        m1[ii][0] = 0;
      } else {
        m1[ii][0]++;
        m1[ii][1] = jj;
        const size = 1 << (m1[ii][0] - 1);
        for (let x = 0; x < size; x++) {
          const p = document.getElementById('p' + i + '_' + (j + x));
          p.classList.add('on');
        }
      }
    }

    function update_sprite_code() {
      const box = document.getElementById('codeBox');
      box.textContent = gen_grp1_code() + '\n' + gen_m1_code();
    }

    function gen_grp1_code() {
      let code = 'CACTUS_SPRITE:\n';
      code += '.ds 1             ;â\n';
      for (let i = cactus_grp1_h - 2; i >= 1; i--) {
        code += '  .byte #%' + grp1[i].join('') + '  ;â ';
        code += grp1[i].map(x => x ? 'â–ˆ' : ' ').join('') + '\n';
      }
      code += '  .ds 1             ;â\n'
      code += 'CACTUS_SPRITE_END = *\n';
      return code;
    }

    function gen_m1_code() {
      const label = 'CACTUS_MISSILE_1_CONF:\n';
      const last_label = 'CACTUS_MISSILE_1_CONF_END = *\n';
      let first_scanline = '  .ds 1             ;â\n';
      let last_scanline = first_scanline;
      let code = '';
      for (let i = cactus_m1_h - 2; i >= 1; i--) {
        const enam1 = m1[i][0] ? '10' : '00';
        const nusiz1 = Math.max(0, m1[i][0] - 1).toString(2).padStart(2, '0');
        const missile_j_prev_scanline = m1[i - 1][1];
        const missile_j = m1[i][1];
        if (i == cactus_m1_h - 2 && missile_j > 8) {
          first_scanline = `  .byte #%1000${nusiz1}${enam1}  ;|\n`;

          let offset = (missile_j - 8) & 0xf;
          let hmm1 = offset.toString(2).padStart(4, '0');

          code += `  .byte #%${hmm1}${nusiz1}${enam1}  ;|\n`;
        } else if (missile_j_prev_scanline - 7 <= missile_j && missile_j <= missile_j_prev_scanline + 8) {
          const offset = (missile_j - missile_j_prev_scanline) & 0xf;
          const hmm1 = offset.toString(2).padStart(4, '0');

          code += `  .byte #%${hmm1}${nusiz1}${enam1}  ;|\n`;
        } else {
          code += `  .byte #%xxxx${nusiz1}${enam1}  ;| <-- INVALID offset for HMM1!!!\n`;
        }
      }
      return label + first_scanline + code + last_scanline + last_label;
    }

    // Initial render
    for (let i = 0; i < rows; i++) {
      for (let j = 0; j < cols; j++) {
        const pixel = document.createElement('div');
        pixel.id = 'p' + i + '_' + j;
        pixel.classList.add('pixel');
        const bij = board[i] ? board[i][j] : ' ';
        let type = 'off';
        if (bij === '_') type = 'bottom';
        else if (bij === '^') type = 'top';
        else if (bij === 'O') type = 'on';
        pixel.appendChild(create_pixel_svg(type));

        const gi = i - cactus_grp1_y;
        const gj = j - cactus_grp1_x;
        if (0 <= gi && gi < cactus_grp1_h && 0 <= gj && gj < cactus_grp1_w) {
          pixel.classList.add('grp1');
          pixel.i = gi;
          pixel.j = gj;
          pixel.addEventListener('mousedown', e => {
            e.preventDefault();
            toggle_pixel(pixel);
            update_sprite_code();
            update_mini_grid();
          });
          pixel.addEventListener('mouseover', () => {
            if (pixel.i === 0 || pixel.i === 16) pixel.style.cursor = 'not-allowed';
            if (is_mouse_down && !mouse_down_processed_pixels[gi][gj]) {
              toggle_pixel(pixel);
              mouse_down_processed_pixels[gi][gj] = 1;
              update_sprite_code();
              update_mini_grid();
            }
          });
        }

        const mi = i - cactus_m1_y;
        const mj = j - cactus_m1_x;
        if (0 <= mi && mi < cactus_m1_h && 0 <= mj && mj < cactus_m1_w) {
          pixel.classList.add('m1');
          pixel.i = mi;
          pixel.j = mj;

          pixel.addEventListener('mousedown', e => {
            e.preventDefault();
            toggle_missile_pixel(pixel);
            update_sprite_code();
            update_mini_grid();
          });

          pixel.addEventListener('mouseover', () => {
            // The first row (from bottom up) can only do a fine offset of 
            // of 8 px to the right (HMM1)
            if (1 < mi && mi <= cactus_m1_h - 3) {
              // Check that mj is [-7, +8] from the position of the previous 
              // missile
              //
              // Previous in this context means the next scanline, as they 
              // will be drawn from bottom to top
              const prev_missile_j = m1[mi + 1][1];
              if (!(prev_missile_j - 7 <= mj && mj <= prev_missile_j + 8)) {
                pixel.style.cursor = 'not-allowed';
              } else {
                pixel.style.cursor = 'pointer';
              }
            }
          });
        }

        grid.appendChild(pixel);
      }
    }

    update_sprite_code();
    update_mini_grid();
  </script>
</body>
</html>
